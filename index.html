<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RobotMagic Pro - Trading Bot</title>
    <link rel="stylesheet" href="/static/style.css"> 
    
    <style>
        /*
        ===================================================================
        BLOCO DE CSS EMBEDIDO (CASO NECESS√ÅRIO, MAS EST√Å NO /static/style.css)
        ===================================================================
        */
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #e0e0e0;
            --muted-color: #9e9e9e;
            --accent-blue: #00bcd4; /* Cor prim√°ria da Deriv/Binary */
            --accent-red: #f44336;
            --accent-green: #4caf50;
            --border-color: #333;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* GEST√ÉO DE VIEWS (Mantido o seu estilo original) */
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .page-content {
            padding: 20px;
            background-color: var(--card-color);
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        .page-content.hidden {
            display: none;
        }

        /* DASHBOARD */
        #dashboard-view {
            display: grid;
            grid-template-columns: 250px 1fr;
            height: 100vh;
        }

        header {
            grid-column: 1 / 3;
            background-color: var(--card-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        main {
            display: flex;
            flex-grow: 1;
        }

        .side-menu {
            width: 250px;
            background-color: var(--card-color);
            padding: 20px 0;
            border-right: 1px solid var(--border-color);
        }

        .side-menu a {
            display: block;
            color: var(--text-color);
            padding: 12px 20px;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .side-menu a:hover {
            background-color: #2a2a2a;
            color: var(--accent-blue);
        }

        /* --- Estilos do Bots List (Mantenha este bloco) --- */
        .bot-creation-form {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid var(--accent-blue);
        }
        
        .input-group-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .input-group-grid input, .input-group-grid select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: #333;
            color: var(--text-color);
        }
        
        .input-group-grid button {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .input-group-grid button:hover {
            background-color: #00a0b0;
        }

        .bots-list table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .bots-list th, .bots-list td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .bots-list th {
            background-color: #2a2a2a;
            color: var(--accent-blue);
        }
        .bots-list td button {
            background-color: #333;
            color: var(--text-color);
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        .bots-list td button:hover {
            background-color: #444;
        }
        /* FIM dos estilos do Bots List */
    </style>
</head>
<body>

    <div id="app-container">

        <div id="login-view" class="view active">
            <div class="login-box">
                <h1>RobotMagic Pro</h1>
                <p>An√°lise Profissional (Deriv, Binary, Binance Style)</p>
                <div class="input-group">
                    <input type="password" id="tokenInput" placeholder="Insira seu Token API da Deriv">
                    <button id="connectBtn" onclick="setTokenAndConnect()">CONECTAR</button> 
                </div>
                <p id="auth-status" class="status-message"></p>
            </div>
        </div>

        <div id="dashboard-view" class="view">
            
            <header>
                <div class="logo">RM Pro</div>
                <nav>
                    <span id="account-type" class="badge demo">DEMO</span>
                    <span id="account-balance" class="badge">Saldo: $0.00</span>
                    <span id="current-asset" class="badge asset">Ativo: V100 Index</span>
                    <button id="menu-btn" onclick="toggleMenu()">‚ò∞ Menu</button>
                </nav>
            </header>

            <main>
                <div id="side-menu" class="side-menu">
                    <a href="#" onclick="showView('analysis-view')">‚öôÔ∏è P√°gina Inicial (An√°lise)</a>
                    <a href="#" onclick="showView('bots-view')">ü§ñ Bots Autom√°ticos</a>
                    <a href="#" onclick="showView('ia-view')">üí° IA Trader</a>
                    <a href="#" onclick="logout()">üîì Sair</a>
                </div>

                <section id="analysis-view" class="page-content active">
                    <h2>An√°lise T√©cnica em Tempo Real</h2>
                    <div class="controls-bar">
                        <select id="symbolSel">
                            <option value="R_100">Volatility 100 Index</option>
                            <option value="EURUSD">EUR/USD</option>
                        </select>
                        <button id="startAnalysisBtn" onclick="startAnalysis()">Iniciar An√°lise</button>
                        <button id="stopAnalysisBtn" class="hidden" onclick="stopAnalysis()">Parar An√°lise</button>
                    </div>

                    <div id="signal-display" class="signal-box hidden">
                        <p>Pre√ßo Atual: <span id="current-price">$0.00</span></p>
                        <h3 id="signal-action">-</h3>
                        <p>Probabilidade: <span id="signal-prob">0%</span></p>
                        <p id="signal-reason" class="muted"></p>
                    </div>
                </section>

                <section id="bots-view" class="page-content hidden">
                    <h2>Gest√£o de Bots Autom√°ticos</h2>
                    
                    <div class="bot-creation-form">
                        <h3>Criar e Iniciar Novo Bot</h3>
                        <div class="input-group-grid">
                            <input type="text" id="bot_name" placeholder="Nome do Bot (Ex: Scalper V50)" required>
                            <select id="bot_symbol" required>
                                <option value="R_100">Volatility 100 Index</option>
                                <option value="R_50">Volatility 50 Index</option>
                                <option value="R_25">Volatility 25 Index</option>
                            </select>
                            <select id="bot_tf" required>
                                <option value="5">TF 5 Ticks</option>
                                <option value="10">TF 10 Ticks</option>
                                <option value="20">TF 20 Ticks</option>
                                <option value="30">TF 30 Ticks</option>
                            </select>
                             <input type="number" id="bot_sl" placeholder="Stop Loss ($)" value="10.0" step="0.5" required>
                            <input type="number" id="bot_tp" placeholder="Take Profit ($)" value="5.0" step="0.5" required>
                            <button onclick="createBot()">Criar e Iniciar</button> 
                        </div>
                    </div>
                    
                    <h3>Bots Ativos/Registados</h3>
                    <div id="bots_list" class="bots-list"> 
                        <p class="muted">Nenhum bot registado ainda.</p>
                    </div>
                </section>

                <section id="ia-view" class="page-content hidden">
                    <h2>IA Trader Assistant</h2>
                    <div class="ia-input-group">
                        <input type="text" id="iaQuery" placeholder="Pergunte sobre An√°lise T√©cnica..." required>
                        <button onclick="sendIAQuery()">Perguntar</button>
                    </div>
                    <div id="iaResponse" class="ia-response-box">
                        <strong>Resposta da IA:</strong>
                        <p class="muted">Aguardando a sua pergunta.</p>
                    </div>
                </section>


            </main>
        </div>
    </div>

    <script>
        const SERVER = ""; 
        let isAnalysisRunning = false;
        let isConnected = false;
        let checkStatusInterval = null;
        let analysisTimeout = null;
        
        function log(message) {
            console.log("[FRONT-END] " + message);
        }
        
        // --------------------------------------
        // FUN√á√ïES DE COMUNICA√á√ÉO (API)
        // --------------------------------------
        async function api(path, method = "GET", body = null) {
            try {
                const r = await fetch(SERVER + path, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: body ? JSON.stringify(body) : null,
                });
                const data = await r.json();
                if (!r.ok) {
                    log(`ERRO HTTP ${r.status}: ${data.detail || data.message}`);
                    return { error: true, message: data.detail || data.message };
                }
                return data;
            } catch (e) {
                log("ERRO API (Rede): " + e);
                return { error: true, message: "Erro de rede ou JSON inv√°lido." };
            }
        }
        
        // --------------------------------------
        // GEST√ÉO DE VIEWS (Mantida a sua l√≥gica original)
        // --------------------------------------
        function showView(viewId) {
            log(`Mudar para vista: ${viewId}`);
            document.querySelectorAll('.page-content').forEach(view => {
                view.classList.add('hidden');
            });
            
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('dashboard-view').classList.add('active');
            }
            
            // Se mudar para a gest√£o de bots, carrega a lista
            if (viewId === 'bots-view') {
                fetchBotsList(); 
            }
            
            if (window.innerWidth <= 768) {
                document.getElementById('side-menu').classList.remove('open');
            }
        }

        function toggleMenu() {
            document.getElementById('side-menu').classList.toggle('open');
        }

        function logout() {
            // Limpa o estado e volta para a view de login
            clearInterval(checkStatusInterval); 
            isAnalysisRunning = false;
            isConnected = false;
            showView('login-view');
            window.location.reload(); // Simplificado para recarregar
        }

        // --------------------------------------
        // FUN√á√ïES DE STATUS E LOGIN
        // --------------------------------------
        async function checkStatus() {
            const s = await api("/status");
            if (!s || s.error) {
                document.getElementById("auth-status").innerHTML = "üî¥ Servidor ou API Deriv Inativo.";
                isConnected = false;
                // Mudar para login se houver erro no status e estiver no dashboard
                if (document.getElementById("dashboard-view").classList.contains('active')) {
                     document.getElementById('login-view').classList.add('active');
                     document.getElementById('dashboard-view').classList.remove('active');
                }
                return;
            }

            isConnected = s.connected;
            
            // Atualizar status de conex√£o
            document.getElementById("auth-status").innerHTML =
                s.authorized
                    ? `<span style="color:lime">üü¢ Conex√£o Ativa - ${s.account_type.toUpperCase()}</span>`
                    : `<span style="color:red">üî¥ Conex√£o N√£o Autorizada</span>`;
            
            // Atualizar dashboard
            if (s.authorized) {
                document.getElementById("account-balance").innerHTML =
                    `Saldo: ${parseFloat(s.balance).toFixed(2)} ${s.currency}`;
                
                const typeBadge = document.getElementById("account-type");
                typeBadge.innerHTML = s.account_type.toUpperCase();
                typeBadge.className = `badge ${s.account_type}`;
                
                // Transi√ß√£o para dashboard
                if (document.getElementById("login-view").classList.contains('active')) {
                    document.getElementById('login-view').classList.remove('active');
                    document.getElementById('dashboard-view').classList.add('active');
                }
            } else {
                 document.getElementById("account-balance").innerHTML = "Saldo: $0.00";
            }
        }

        async function setTokenAndConnect() {
            const token = document.getElementById("tokenInput").value.trim();
            if (!token) {
                document.getElementById("auth-status").innerHTML = "<span style='color:yellow'>Por favor, insira o token.</span>";
                return;
            }

            document.getElementById("auth-status").innerHTML = "Enviando token e conectando...";

            // üü¢ Rota e corpo corretos
            const r = await api("/set_token", "POST", { token }); 

            if (r && !r.error) {
                document.getElementById("auth-status").innerHTML =
                    "<span style='color:lime'>Token enviado. Verificando autoriza√ß√£o...</span>";
            } else {
                document.getElementById("auth-status").innerHTML =
                    `<span style='color:red'>Erro: ${r.message || "Falha ao enviar token."}</span>`;
            }
        }
        
        // --------------------------------------
        // FUN√á√ïES DE AN√ÅLISE MANUAL (Mantidas)
        // --------------------------------------
        function startAnalysis() {
            isAnalysisRunning = true;
            document.getElementById('startAnalysisBtn').classList.add('hidden');
            document.getElementById('stopAnalysisBtn').classList.remove('hidden');
            document.getElementById('signal-display').classList.remove('hidden');
            fetchSignal();
        }

        function stopAnalysis() {
            isAnalysisRunning = false;
            document.getElementById('startAnalysisBtn').classList.remove('hidden');
            document.getElementById('stopAnalysisBtn').classList.add('hidden');
            document.getElementById('signal-display').classList.add('hidden');
            clearTimeout(analysisTimeout);
        }

        async function fetchSignal() {
            if (!isAnalysisRunning || !isConnected) return;
            const sym = document.getElementById("symbolSel").value;
            
            const r = await api(`/signal/${sym}`);
            
            if (r && !r.error) {
                document.getElementById("current-price").innerText = r.current_price;
                document.getElementById("current-asset").innerText = `Ativo: ${sym}`;
                document.getElementById("signal-action").innerText = r.signal || "AGUARDANDO SINAL";
                document.getElementById("signal-prob").innerText = `${(r.probability * 100).toFixed(0)}%`;
                document.getElementById("signal-reason").innerText = r.reason;
                
                // Aplica cor
                const actionElement = document.getElementById("signal-action");
                if (r.signal === "CALL (COMPRA)") {
                     actionElement.style.color = 'var(--accent-green)';
                } else if (r.signal === "PUT (VENDA)") {
                    actionElement.style.color = 'var(--accent-red)';
                } else {
                    actionElement.style.color = 'var(--muted-color)';
                }
            } else {
                log(`Erro ao buscar sinal: ${r.message || 'Erro de rede.'}`);
            }

            analysisTimeout = setTimeout(fetchSignal, 3000); // Tenta novamente a cada 3 segundos
        }

        // --------------------------------------
        // FUN√á√ïES DE BOTS AUTOM√ÅTICOS (NOVAS)
        // --------------------------------------

        async function createBot() {
            const name = document.getElementById("bot_name").value;
            const symbol = document.getElementById("bot_symbol").value;
            const tf = document.getElementById("bot_tf").value;
            const stop_loss = parseFloat(document.getElementById("bot_sl").value);
            const take_profit = parseFloat(document.getElementById("bot_tp").value);
            
            if (!name || !symbol || !tf || isNaN(stop_loss) || isNaN(take_profit)) {
                alert("Preencha todos os campos corretamente.");
                return;
            }

            const r = await api("/create_bot", "POST", {
                name,
                symbol,
                tf,
                stop_loss,
                take_profit,
            });

            if (r && r.id) {
                alert(`Bot '${name}' criado e ATIVADO com sucesso! ID: ${r.id}`);
                fetchBotsList();
            } else if (r && r.error) {
                alert("Erro ao criar bot: " + r.message);
            } else {
                alert("Erro desconhecido ao criar bot.");
            }
        }

        async function toggleBot(id, action) {
            const path = `/bot/${id}/${action}`; // 'activate' ou 'deactivate'
            
            const r = await api(path, "POST");
            
            if (r && !r.error) {
                alert(`Bot ${id.substring(0, 8)}... ${action === 'activate' ? 'Ativado' : 'Parado'}.`);
                fetchBotsList();
            } else if (r && r.error) {
                 alert(`Erro ao ${action === 'activate' ? 'ativar' : 'parar'} bot: ${r.message}`);
            }
        }

        async function fetchBotsList() {
            const div = document.getElementById("bots_list");
            div.innerHTML = "<p class='muted'>A carregar a lista de bots...</p>";
            
            const bots = await api("/bots");

            if (!bots || bots.error) {
                div.innerHTML = "<p class='muted' style='color:var(--accent-red)'>Erro ao carregar bots.</p>";
                return;
            }

            let html = "<table><thead><tr><th>ID</th><th>Nome</th><th>S√≠mbolo</th><th>TF</th><th>SL/TP</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>";
            
            bots.forEach(b => {
                const statusText = b.state === 'ACTIVE' ? "üü¢ ATIVO" : "üî¥ INATIVO";
                const activateBtn = `<button onclick="toggleBot('${b.id}', 'activate')" ${b.state === 'ACTIVE' ? 'disabled' : ''}>Ativar</button>`;
                const deactivateBtn = `<button onclick="toggleBot('${b.id}', 'deactivate')" ${b.state === 'INACTIVE' ? 'disabled' : ''}>Parar</button>`;
                
                html += `
                <tr>
                    <td>${b.id.substring(0, 4)}...</td>
                    <td>${b.name}</td>
                    <td>${b.symbol}</td>
                    <td>${b.tf} Ticks</td>
                    <td>$${b.stop_loss} / $${b.take_profit}</td>
                    <td>${statusText}</td>
                    <td>${activateBtn} ${deactivateBtn}</td>
                </tr>
                `;
            });

            html += "</tbody></table>";
            
            if (bots.length === 0) {
                html = "<p class='muted'>Nenhum bot registado ainda.</p>";
            }

            div.innerHTML = html;
        }


        // --------------------------------------
        // FUN√á√ïES DE IA TRADER (Mantidas)
        // --------------------------------------
        async function sendIAQuery() {
            const query = document.getElementById('iaQuery').value.trim();
            const responseBox = document.getElementById('iaResponse');
            
            if (!query) return;

            responseBox.innerHTML = '<strong>Resposta da IA:</strong><p class="muted">Analisando a sua pergunta...</p>';
            document.getElementById('iaQuery').value = '';

            try {
                const r = await api("/ia/query", "POST", { query: query });
                
                if (r && r.response) {
                    responseBox.innerHTML = `<strong>Resposta da IA:</strong><p>${r.response}</p>`;
                } else {
                    responseBox.innerHTML = `<strong>Resposta da IA:</strong><p class="muted" style="color:var(--accent-red)">Erro: ${r.message || 'Resposta inv√°lida do servidor.'}</p>`;
                }

            } catch (e) {
                responseBox.innerHTML = '<strong>Resposta da IA:</strong><p class="muted" style="color:var(--accent-red)">Erro de rede ao consultar a IA.</p>';
                log("Erro IA: " + e.message);
            }
        }

        // --------------------------------------
        // INICIALIZA√á√ÉO
        // --------------------------------------

        window.onload = function() {
            // Inicia o loop de status a cada 2 segundos
            checkStatusInterval = setInterval(checkStatus, 2000); 
            showView('analysis-view');
        };

    </script>
</body>
</html>
