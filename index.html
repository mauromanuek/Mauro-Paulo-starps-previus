<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RobotMagic Pro — Conexão Deriv</title>
<style>
:root{--bg:#0a0f17;--card:#111821;--accent:#2ecc71;--muted:#9aa6b2;}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:#e9f7ef}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;border-bottom:1px solid rgba(255,255,255,0.03)}
.logo{display:flex;align-items:center;gap:12px}
.logo .dot{width:40px;height:40px;border-radius:8px;background:linear-gradient(45deg,var(--accent),#3498db);display:flex;align-items:center;justify-content:center;font-weight:700;color:#001}
.container{padding:16px;display:grid;grid-template-columns:300px 1fr 360px;gap:14px}
.panel{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.chart{height:420px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:var(--muted)}
.btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#001;cursor:pointer;font-weight:600}
.muted{color:var(--muted);font-size:13px}
#modalToken{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.65);display:none;align-items:center;justify-content:center}
.modal{width:420px;background:var(--card);padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:#e9f7ef}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="dot">RM</div>
    <div>
      <div style="font-weight:700">RobotMagic Pro</div>
      <div class="small">Painel — insira token para conectar à Deriv</div>
    </div>
  </div>
  <div>
    <button class="btn" id="openTokenBtn">Conectar Deriv</button>
  </div>
</header>

<div class="container">
  <aside class="panel">
    <h3>Config</h3>
    <div class="muted">Ativo</div>
    <select id="symbolSel" class="input" style="margin-top:6px">
      <option value="R_100">R_100</option>
      <option value="R_50">R_50</option>
      <option value="FRXEURUSD">EURUSD</option>
    </select>
    <div style="margin-top:10px" class="muted">Timeframe</div>
    <select id="tfSel" class="input" style="margin-top:6px">
      <option value="60">1m</option>
      <option value="300">5m</option>
    </select>

    <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

    <h4>Conexão</h4>
    <div id="connStatus" class="small">Desconectado</div>
    <div style="margin-top:8px"><button class="btn" id="openTokenBtn2">Inserir token</button></div>

    <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

    <h4>Histórico</h4>
    <div id="history" class="muted">Nenhum histórico</div>
  </aside>

  <main class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Gráfico (preview)</h3>
      <div class="muted">Último sinal: <span id="lastSignal">—</span></div>
    </div>

    <div class="chart" id="chart">Gráfico placeholder</div>

    <div style="margin-top:12px">
      <h4>Sinais</h4>
      <div id="signals" class="muted">Nenhum sinal</div>
    </div>
  </main>

  <aside class="panel">
    <h4>Análise</h4>
    <div id="analysis" class="muted">Sem análise</div>

    <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

    <h4>Logs</h4>
    <div id="logs" class="muted" style="height:240px;overflow:auto">Sem logs</div>
  </aside>
</div>

<!-- TOKEN MODAL (Opção A: modal elegante) -->
<div id="modalToken">
  <div class="modal">
    <h3>Conectar à Deriv</h3>
    <div class="small">Cole o token da Deriv (somente leitura ou com permissões que desejar).</div>
    <input id="tokenInput" class="input" placeholder="Cole seu token aqui" style="margin-top:10px"/>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button class="btn" id="btnSendToken">Conectar</button>
      <button class="btn" id="btnCancelToken" style="background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)">Cancelar</button>
    </div>
    <div class="small" style="margin-top:10px;color:var(--muted)">O token fica EM MEMÓRIA no servidor e será perdido ao reiniciar o serviço.</div>
  </div>
</div>

<script>
const SERVER = location.origin; // usa mesmo host do render
const modal = document.getElementById("modalToken");
document.getElementById("openTokenBtn").onclick = ()=> modal.style.display = "flex";
document.getElementById("openTokenBtn2").onclick = ()=> modal.style.display = "flex";
document.getElementById("btnCancelToken").onclick = ()=> modal.style.display = "none";

function log(txt){
  const logs = document.getElementById("logs");
  logs.innerText = new Date().toLocaleTimeString() + " — " + txt + "\n" + logs.innerText;
}

async function sendToken(){
  const token = document.getElementById("tokenInput").value.trim();
  if(!token){ alert("Insira o token"); return; }
  document.getElementById("btnSendToken").disabled = true;
  try{
    const res = await fetch(SERVER + "/set_token", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({token})
    });
    const j = await res.json();
    if(res.ok){
      modal.style.display = "none";
      document.getElementById("connStatus").innerText = "Conectando... (aguarde)";
      log("Token enviado. Aguardando conexão...");
      // esperar um pouco e checar health
      setTimeout(checkConn, 2000);
    } else {
      alert("Erro: " + (j.detail || JSON.stringify(j)));
      document.getElementById("btnSendToken").disabled = false;
    }
  }catch(e){
    alert("Erro ao enviar token: " + e.message);
    document.getElementById("btnSendToken").disabled = false;
  }
}

document.getElementById("btnSendToken").onclick = sendToken;

async function checkConn(){
  try{
    const r = await fetch(SERVER + "/api");
    const j = await r.json();
    if(j.deriv_connected){
      document.getElementById("connStatus").innerText = "Conectado ✅";
      log("Servidor conectado à Deriv.");
    } else {
      document.getElementById("connStatus").innerText = "Desconectado";
      log("Servidor ainda desconectado.");
    }
  }catch(e){
    log("Erro health: "+e.message);
  } finally {
    document.getElementById("btnSendToken").disabled = false;
  }
}

// fetch signal periodically
async function fetchSignal(){
  const sym = document.getElementById("symbolSel").value;
  const tf = document.getElementById("tfSel").value;
  try{
    const r = await fetch(SERVER + "/signal?symbol="+encodeURIComponent(sym)+"&tf="+encodeURIComponent(tf));
    const j = await r.json();
    if(j && j.action){
      document.getElementById("signals").innerHTML = `<div style="padding:8px;background:rgba(255,255,255,0.02);border-radius:8px">
        <strong>${j.action} — ${(j.probability*100).toFixed(0)}%</strong>
        <div class="small">${j.symbol} | TF: ${j.tf}</div>
        <div class="small" style="margin-top:6px">${j.reason}</div>
      </div>`;
      document.getElementById("lastSignal").innerText = j.action + " (" + (j.probability*100).toFixed(0) + "%)";
      document.getElementById("analysis").innerText = j.explanation || j.reason;
      // history
      const h = document.getElementById("history");
      h.innerText = new Date(j.generated_at).toLocaleTimeString() + " — " + j.symbol + " " + j.action + " " + (j.probability*100).toFixed(0) + "%\n" + h.innerText;
    } else {
      // no signal
      //document.getElementById("signals").innerText = "Nenhum sinal no momento";
    }
  }catch(e){
    log("Erro fetchSignal: " + e.message);
  }
}

setInterval(fetchSignal, 7000);
fetchSignal();
checkConn(); // check at load
</script>
</body>
</html>
