<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RobotMagic Pro - Trading Bot</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* CORRE√á√ÉO VISUAL: ESCONDER A ASIDE (LOGS) */
        aside {
            display: none !important; 
        }
        /* Ajusta o grid do dashboard para ocupar o espa√ßo do aside */
        #dashboard-view main {
            grid-column: 1 / -1; /* Faz o MAIN ocupar toda a largura */
        }
    </style>
</head>
<body>

    <div id="app-container">

        <div id="login-view" class="view active">
            <div class="login-box">
                <h1>RobotMagic Pro</h1>
                <p>An√°lise Profissional (Deriv, Binary, Binance Style)</p>
                <div class="input-group">
                    <input type="password" id="tokenInput" placeholder="Insira seu Token API da Deriv">
                    <button id="connectBtn" onclick="setTokenAndConnect()">CONECTAR</button>
                </div>
                <p id="auth-status" class="status-message"></p>
            </div>
        </div>

        <div id="dashboard-view" class="view">
            
            <header>
                <div class="logo">RM Pro</div>
                <nav>
                    <span id="account-type" class="badge demo">DEMO</span>
                    <span id="account-balance" class="badge">Saldo: $0.00</span>
                    <span id="current-asset" class="badge asset">Ativo: V100 Index</span>
                    <button id="menu-btn" onclick="toggleMenu()">‚ò∞ Menu</button>
                </nav>
            </header>

            <main>
                <div id="side-menu" class="side-menu closed">
                    <button class="nav-button active" onclick="showContent('analysis-content')">An√°lise Manual</button>
                    <button class="nav-button" onclick="showContent('bots-content')">Bots Autom√°ticos</button>
                    <button class="nav-button" onclick="showContent('ia-content')">IA Trader</button>
                </div>

                <div id="content-container">

                    <div id="analysis-content" class="content-view active">
                        <h2>An√°lise de Mercado em Tempo Real</h2>

                        <div class="card analysis-controls">
                            <h3>An√°lise de Sinais Manual</h3>
                            <div class="input-group">
                                <select id="signalAsset" disabled>
                                    <option value="R_100">Volatility 100 Index (R_100)</option>
                                    <option value="R_50">Volatility 50 Index (R_50)</option>
                                    <option value="R_25">Volatility 25 Index (R_25)</option>
                                </select>
                                <select id="signalTF" disabled>
                                    <option value="TICK">Tick</option>
                                    <option value="M1">M1 (1 Minuto)</option>
                                    <option value="M5">M5 (5 Minutos)</option>
                                </select>
                                <button id="getSignalBtn" onclick="getSignal()" disabled>COME√áAR AN√ÅLISE</button>
                            </div>
                        </div>

                        <div id="signal-output" class="card signal-box">
                            <p class="muted">Aguardando o clique em "COME√áAR AN√ÅLISE".</p>
                        </div>

                    </div>
                    
                    <div id="bots-content" class="content-view">
                        <h2>Bots de Trading Ativos</h2>
                        <div class="card">
                            <p class="muted">A sec√ß√£o de Bots ser√° implementada na pr√≥xima fase.</p>
                        </div>
                    </div>

                    <div id="ia-content" class="content-view">
                        <h2>IA Trader (An√°lise T√©cnica Aprofundada)</h2>
                        <div class="card">
                            <p>Pergunte sobre qualquer conceito ou padr√£o de an√°lise t√©cnica e receba uma explica√ß√£o e recursos.</p>
                            <div class="ia-input-group">
                                <input type="text" id="iaQuery" placeholder="Ex: O que √© um tri√¢ngulo ascendente?">
                                <button onclick="iaQuery()">Perguntar</button>
                            </div>
                            <div id="iaResponse" class="ia-response-box">
                                <strong>Resposta da IA:</strong>
                                <p class="muted">Pronto para a sua pergunta.</p>
                            </div>
                        </div>
                    </div>

                </div>
            </main>

            <aside>
                <div class="log-box">
                    <h4>Log de Atividades</h4>
                    <div id="log-output"></div>
                </div>
            </aside>
            
        </div>
    </div>

    <script>
        // üö® LEMBRE-SE DE SUBSTITUIR PELO SEU DOM√çNIO DO RENDER üö®
        const SERVER = "https://mauro-paulo-starps-previus.onrender.com"; 
        
        // --------------------------------------
        // FUN√á√ïES DE UTILIDADE
        // --------------------------------------

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
        }

        function showContent(contentId) {
            document.querySelectorAll('.content-view').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(contentId).classList.add('active');

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-button[onclick="showContent('${contentId}')"]`).classList.add('active');
        }

        function toggleMenu() {
            const menu = document.getElementById('side-menu');
            menu.classList.toggle('closed');
        }

        function log(message) {
            // MANTEMOS A FUN√á√ÉO LOG AQUI, mas ela s√≥ escreve na consola (F12)
            console.log(`[LOG] ${message}`);
            
            // O c√≥digo abaixo √© apenas se voc√™ quiser re-ativar a exibi√ß√£o no DOM:
            // const logOutput = document.getElementById('log-output');
            // const now = new Date();
            // const time = now.toLocaleTimeString();
            // logOutput.innerHTML = `[${time}] ${message}<br>` + logOutput.innerHTML;
        }

        // --------------------------------------
        // FUN√á√ïES DE CONEX√ÉO E STATUS
        // --------------------------------------

        async function setTokenAndConnect() {
            const tokenInput = document.getElementById('tokenInput');
            const statusMessage = document.getElementById('auth-status');
            const connectBtn = document.getElementById('connectBtn');
            const token = tokenInput.value.trim();

            if (token.length < 15) {
                statusMessage.textContent = 'Token inv√°lido.';
                return;
            }

            statusMessage.textContent = 'A conectar... Aguarde 8 segundos.';
            connectBtn.disabled = true;

            try {
                const r = await fetch(SERVER + "/set_token", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });

                const j = await r.json();

                if (r.ok) {
                    log('Token enviado. Servidor a autorizar...');
                    checkStatus(); 
                } else {
                    statusMessage.textContent = j.detail || 'Falha na autoriza√ß√£o. Verifique o token.';
                    log(`Falha de conex√£o: ${j.detail}`);
                }

            } catch (e) {
                statusMessage.textContent = 'Erro na verifica√ß√£o de status: Failed to fetch';
                log("Erro de rede: " + e.message);
            } finally {
                connectBtn.disabled = false;
            }
        }

        async function checkStatus() {
            try {
                const r = await fetch(SERVER + "/status");
                const status = await r.json();

                if (status.authorized) {
                    updateDashboard(status);
                } else {
                    updateDashboard(status);
                    setTimeout(checkStatus, 3000); 
                }
            } catch (e) {
                log('Erro na verifica√ß√£o de status: Servidor indispon√≠vel.');
                showView('login-view');
                setTimeout(checkStatus, 5000); 
            }
        }

        function updateDashboard(status) {
            const isAuthorized = status.authorized;
            const balance = status.balance;
            const accountType = status.account_type.toUpperCase();

            // 1. Atualizar Badges de Status
            document.getElementById('account-balance').textContent = `Saldo: $${balance.toFixed(2)}`;
            document.getElementById('account-type').textContent = accountType;
            document.getElementById('account-type').className = `badge ${accountType.toLowerCase()}`;
            
            // 2. Mudar a Vista
            if (isAuthorized) {
                showView('dashboard-view');
                // ATIVA√á√ÉO CR√çTICA DO BOT√ÉO DE AN√ÅLISE 
                document.getElementById('getSignalBtn').disabled = false;
                document.getElementById('signalAsset').disabled = false;
                document.getElementById('signalTF').disabled = false;
                log(`Conex√£o OK. Saldo: $${balance.toFixed(2)} (${accountType})`);
            } else {
                showView('login-view');
                // Desativar o bot√£o se deslogado
                document.getElementById('getSignalBtn').disabled = true;
                document.getElementById('signalAsset').disabled = true;
                document.getElementById('signalTF').disabled = true;
                log('Sess√£o expirada. Por favor, reconecte.');
            }
            setTimeout(checkStatus, 3000);
        }

        // --------------------------------------
        // FUN√á√ïES DE SINAL (AN√ÅLISE MANUAL)
        // --------------------------------------

        async function getSignal() {
            const asset = document.getElementById('signalAsset').value;
            const tf = document.getElementById('signalTF').value;
            const signalBox = document.getElementById('signal-output');
            
            signalBox.innerHTML = '<p class="muted">A analisar o mercado... Coletando 20 ticks de dados. Aguarde 3 segundos.</p>';

            // üü¢ CORRE√á√ÉO DOS 20 TICKS: Esperar 3 segundos para dar tempo de coleta
            await new Promise(resolve => setTimeout(resolve, 3000)); 
            log("Tentando obter sinal do servidor ap√≥s coleta de dados...");


            try {
                const r = await fetch(SERVER + `/signal?symbol=${asset}&tf=${tf}`);
                const j = await r.json();

                if (r.ok) {
                    // Sinal Recebido com Sucesso
                    const actionColor = j.action.startsWith('CALL') ? 'var(--accent-green)' : 'var(--accent-red)';
                    const signalHTML = `
                        <div class="signal-result">
                            <span style="color:${actionColor}; font-weight:bold; font-size:1.4em;">${j.action}</span>
                            <p>Probabilidade: <span class="badge" style="background-color:var(--accent-blue);">${(j.probability * 100).toFixed(0)}%</span></p>
                            <p class="muted">Motivo: ${j.reason}</p>
                            <p class="muted small">${j.explanation}</p>
                        </div>
                    `;
                    signalBox.innerHTML = signalHTML;
                    log(`Sinal gerado: ${j.action} em ${asset}`);

                } else {
                    // Erro ao obter sinal (inclui o erro 404 de "n√£o h√° dados suficientes")
                    signalBox.innerHTML = `<p class="muted" style="color:var(--accent-red)">ERRO: ${j.detail || 'Falha ao obter sinal.'}</p>`;
                    log(`ERRO ao obter sinal: ${j.detail}`);
                }

            } catch (e) {
                signalBox.innerHTML = `<p class="muted" style="color:var(--accent-red)">Erro de rede: ${e.message}</p>`;
                log(`Erro de rede ao buscar sinal: ${e.message}`);
            }
        }
        
        // --------------------------------------
        // FUN√á√ïES DE IA TRADER
        // --------------------------------------
        
        async function iaQuery() {
            const query = document.getElementById('iaQuery').value.trim();
            const responseBox = document.getElementById('iaResponse');
            
            if (!query) return;

            responseBox.innerHTML = '<strong>Resposta da IA:</strong><p class=\"muted\">Analisando a sua pergunta...</p>';
            document.getElementById('iaQuery').value = '';

            try {
                const r = await fetch(SERVER + "/ia/query", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });

                const j = await r.json();
                
                if (j.response) {
                    responseBox.innerHTML = `<strong>Resposta da IA:</strong><p>${j.response}</p>`;
                } else {
                    responseBox.innerHTML = `<strong>Resposta da IA:</strong><p class=\"muted\" style=\"color:var(--accent-red)\">Erro: ${j.message || 'Resposta inv√°lida do servidor.'}</p>`;
                }

            } catch (e) {
                responseBox.innerHTML = '<strong>Resposta da IA:</strong><p class=\"muted\" style=\"color:var(--accent-red)\">Erro de rede ao consultar a IA.</p>';
                log("Erro IA: " + e.message);
            }
        }

        // --------------------------------------
        // INICIALIZA√á√ÉO
        // --------------------------------------

        window.onload = function() {
            checkStatus();
            showContent('analysis-content'); 
        };

    </script>
</body>
</html>
