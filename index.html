<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RobotMagic Pro - Trading Bot</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <div id="app-container">

        <div id="login-view" class="view active">
            <div class="login-box">
                <h1>RobotMagic Pro</h1>
                <p>An√°lise Profissional (Deriv, Binary, Binance Style)</p>
                <div class="input-group">
                    <input type="password" id="tokenInput" placeholder="Insira seu Token API da Deriv">
                    <button id="connectBtn" onclick="setTokenAndConnect()">CONECTAR</button>
                </div>
                <p id="auth-status" class="status-message"></p>
            </div>
        </div>

        <div id="dashboard-view" class="view">
            
            <header>
                <div class="logo">RM Pro</div>
                <nav>
                    <span id="account-type" class="badge demo">DEMO</span>
                    <span id="account-balance" class="badge">Saldo: $0.00</span>
                    <span id="current-asset" class="badge asset">Ativo: V100 Index</span>
                    <button id="menu-btn" onclick="toggleMenu()">‚ò∞ Menu</button>
                </nav>
            </header>

            <main>
                <div id="side-menu" class="side-menu">
                    <a href="#" onclick="showView('analysis-view')">‚öôÔ∏è P√°gina Inicial (An√°lise)</a>
                    <a href="#" onclick="showView('ia-view')">üí° IA Trader</a>
                    <a href="#" onclick="logout()">üîì Sair</a>
                </div>

                <section id="analysis-view" class="page-content active">
                    <h2>An√°lise T√©cnica em Tempo Real</h2>
                    
                    <div class="controls-bar">
                        <select id="symbolSel">
                            <option value="V100">Volatility 100 Index</option>
                            <option value="EURUSD">EUR/USD</option>
                        </select>
                        <select id="tfSel">
                            <option value="60">TF 1 Minuto</option>
                            <option value="300">TF 5 Minutos</option>
                        </select>
                        
                        <button id="startAnalysisBtn" onclick="initiateAnalysis()">INICIAR AN√ÅLISE</button>
                        <button id="stopAnalysisBtn" class="hidden" onclick="stopAnalysis()">PARAR AN√ÅLISE</button>
                        
                        <div id="processing-status" class="processing-bar hidden">
                            <span id="processing-text">Analisando Gr√°fico...</span>
                            <div class="progress"></div>
                        </div>
                    </div>

                    <div id="results-container">
                        <div id="chart-placeholder" class="chart-box">
                            <p>Visualiza√ß√£o do Gr√°fico (Placeholder para dados de ticks)</p>
                            <p class="muted">Aguardando Iniciar An√°lise...</p>
                        </div>
                        
                        <div id="signal-display" class="signal-box hidden">
                            <h3 id="lastSignal">...</h3>
                            <div id="signals" class="signal-details"></div>
                            <div class="analysis-explanation">
                                <strong>Porqu√™ da Decis√£o:</strong>
                                <p id="analysis"></p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="ia-view" class="page-content hidden">
                    <h2>üí° IA Trader (Consulta)</h2>
                    <p class="muted">Pergunte sobre An√°lise T√©cnica, regras dos livros ou o mercado. (Ex: O que √© um tri√¢ngulo ascendente?)</p>
                    
                    <div class="ia-input-group">
                        <input type="text" id="iaQuery" placeholder="Digite sua pergunta sobre Trading...">
                        <button onclick="sendQuery()">Perguntar √† IA</button>
                    </div>
                    
                    <div id="iaResponse" class="ia-response-box">
                        <strong>Resposta da IA:</strong>
                        <p class="muted">Aguardando sua pergunta...</p>
                    </div>
                </section>
                
            </main>
            
            <aside>
                <h3>Hist√≥rico de Sinais</h3>
                <pre id="history"></pre>
            </aside>
        </div>

    </div> 
<script>
    // JS embutido - atualizado: removidos todos os bots
    const SERVER = "";
    let isConnected = false;
    let isAnalysisRunning = false;
    let analysisTimeout = null;

    function showView(viewId) {
        document.querySelectorAll('.page-content').forEach(view => {
            view.classList.add('hidden');
            if (view.id === viewId) {
                view.classList.remove('hidden');
            }
        });
        if (window.innerWidth <= 768) {
            document.getElementById('side-menu').classList.remove('open');
        }
    }

    function toggleMenu() {
        document.getElementById('side-menu').classList.toggle('open');
    }

    async function setTokenAndConnect() {
        const token = document.getElementById("tokenInput").value.trim();
        if (!token) {
            document.getElementById("auth-status").innerText = "ERRO: O Token API n√£o pode estar vazio.";
            return;
        }

        document.getElementById("auth-status").innerText = "Conectando com a Deriv...";
        try {
            const r = await fetch(SERVER + "/set_token", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token })
            });
            const j = await r.json();
            if (j.ok) {
                document.getElementById("auth-status").innerText = "Token Aceito! Verificando conex√£o...";
                setTimeout(checkStatus, 2000);
            } else {
                document.getElementById("auth-status").innerText = "ERRO: " + (j.message || "Falha na conex√£o.");
            }
        } catch (e) {
            document.getElementById("auth-status").innerText = "ERRO de Rede. O servidor est√° offline?";
            console.error(e);
        }
    }

    async function checkStatus() {
        try {
            const r = await fetch(SERVER + "/status");
            const j = await r.json();

            if (j.connected) {
                document.getElementById('login-view').classList.remove('active');
                document.getElementById('dashboard-view').classList.add('active');
                isConnected = true;

                const successMsg = document.createElement('div');
                successMsg.className = 'status-message badge real';
                successMsg.innerText = '‚úÖ CONECTADO com a Deriv!';
                document.querySelector('header').appendChild(successMsg);
                setTimeout(() => {
                    successMsg.style.transition = 'opacity 2s';
                    successMsg.style.opacity = '0';
                    setTimeout(() => successMsg.remove(), 2000);
                }, 3000);

                document.getElementById('account-balance').innerText = `Saldo: $${(j.get('balance') or 0).toFixed ? (j.get('balance') or 0).toFixed(2) : '0.00'}`;
                const typeBadge = document.getElementById('account-type');
                if (j.get('account_type')) {
                    typeBadge.innerText = j.get('account_type').toUpperCase();
                    typeBadge.className = `badge ${j.get('account_type').toLowerCase()}`;
                }
            } else {
                document.getElementById("auth-status").innerText = "Ainda n√£o conectado. Verifique o Token ou tente novamente.";
            }
        } catch (e) {
            console.error(e);
            document.getElementById("auth-status").innerText = "ERRO: O servidor n√£o est√° respondendo.";
        }
    }

    function logout() {
        isConnected = false;
        document.getElementById("tokenInput").value = '';
        document.getElementById('dashboard-view').classList.remove('active');
        document.getElementById('login-view').classList.add('active');
        document.getElementById("auth-status").innerText = '';
    }

    function initiateAnalysis() {
        if (isAnalysisRunning) return;

        isAnalysisRunning = true;
        document.getElementById('startAnalysisBtn').classList.add('hidden');
        document.getElementById('stopAnalysisBtn').classList.remove('hidden');

        document.getElementById('processing-status').classList.remove('hidden');
        document.getElementById('chart-placeholder').classList.add('hidden');
        document.getElementById('signal-display').classList.add('hidden');

        fetchSignal();
    }

    function stopAnalysis() {
        isAnalysisRunning = false;
        if (analysisTimeout) {
            clearTimeout(analysisTimeout);
        }

        document.getElementById('startAnalysisBtn').classList.remove('hidden');
        document.getElementById('stopAnalysisBtn').classList.add('hidden');
        document.getElementById('processing-status').classList.add('hidden');

        document.getElementById('chart-placeholder').classList.remove('hidden');
        document.getElementById('signal-display').classList.add('hidden');
    }

    async function fetchSignal() {
        if (!isAnalysisRunning || !isConnected) return;

        const sym = document.getElementById("symbolSel").value;
        const tf = document.getElementById("tfSel").value;

        document.getElementById('current-asset').innerText = `Ativo: ${sym}`;

        try {
            const r = await fetch(SERVER + "/signal?symbol=" + encodeURIComponent(sym) + "&tf=" + encodeURIComponent(tf));

            if (r.status === 404) {
                document.getElementById('processing-text').innerText = 'Analisando Gr√°fico (Aguardando dados...)...';
                if (isAnalysisRunning) {
                    analysisTimeout = setTimeout(fetchSignal, 5000);
                }
                return;
            }

            const j = await r.json();

            if (j && j.action) {
                stopAnalysis();

                document.getElementById('signal-display').classList.remove('hidden');
                document.getElementById('chart-placeholder').classList.add('hidden');

                const prob = (j.probability * 100).toFixed(0);
                const isCall = j.action.includes("CALL");
                const signalClass = isCall ? 'signal-up' : 'signal-down';
                const arrow = isCall ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';

                document.getElementById("signals").innerHTML =
                    `<div style="padding:15px;" class="${signalClass}">
                        <strong style="font-size:1.5em">${arrow} ${j.action} (${prob}%)</strong>
                        <div>${j.symbol} | TF ${j.tf}</div>
                        <div class="muted">${j.reason}</div>
                    </div>`;

                document.getElementById("lastSignal").innerHTML =
                    `<span class="${signalClass}">${arrow} Sinal de ${j.action}</span>`;

                document.getElementById("analysis").innerText = j.explanation;

                let h = document.getElementById("history");
                h.innerText = new Date(j.generated_at * 1000).toLocaleTimeString() +
                    " ‚Äî " + j.symbol + " " + j.action + ` (${prob}%)` + "\n" + h.innerText;
            }

        } catch (e) {
            console.error("Erro signal:", e);
        }

        if (isAnalysisRunning) {
            analysisTimeout = setTimeout(fetchSignal, 6000);
        }
    }

    async function sendQuery() {
        const query = document.getElementById('iaQuery').value.trim();
        const responseBox = document.getElementById('iaResponse');

        if (!query) return;

        responseBox.innerHTML = '<strong>Resposta da IA:</strong><p class="muted">Analisando a sua pergunta...</p>';
        document.getElementById('iaQuery').value = '';

        try {
            const r = await fetch(SERVER + "/ia/query", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            });

            const j = await r.json();

            if (j.response) {
                responseBox.innerHTML = `<strong>Resposta da IA:</strong><p>${j.response}</p>`;
            } else {
                responseBox.innerHTML = `<strong>Resposta da IA:</strong><p class="muted" style="color:var(--accent-red)">Erro: ${j.message || 'Resposta inv√°lida do servidor.'}</p>`;
            }

        } catch (e) {
            responseBox.innerHTML = '<strong>Resposta da IA:</strong><p class="muted" style="color:var(--accent-red)">Erro de rede ao consultar a IA.</p>';
            console.error("Erro IA:", e);
        }
    }

    window.onload = function() {
        checkStatus();
        showView('analysis-view');
    };
</script>
</body>
</html>
