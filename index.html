<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RobotMagic Pro - Trading Bot</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <div id="app-container">

        <div id="login-view" class="view active">
            <div class="login-box">
                <h1>RobotMagic Pro</h1>
                <p>An√°lise Profissional (Deriv, Binary, Binance Style)</p>
                <div class="input-group">
                    <input type="password" id="tokenInput" placeholder="Insira seu Token API da Deriv">
                    <button id="connectBtn" onclick="setTokenAndConnect()">CONECTAR</button>
                </div>
                <p id="auth-status" class="status-message"></p>
            </div>
        </div>

        <div id="dashboard-view" class="view">
            
            <header>
                <div class="logo">RM Pro</div>
                <nav>
                    <span id="account-type" class="badge demo">DEMO</span>
                    <span id="account-balance" class="badge">Saldo: $0.00</span>
                    <span id="current-asset" class="badge asset">Ativo: R_100 Index</span>
                    <button id="menu-btn" onclick="toggleMenu()">‚ò∞ Menu</button>
                </nav>
            </header>

            <div id="side-menu" class="side-menu">
                <a href="#" onclick="showView('analysis-view')">An√°lise de Sinais</a>
                <a href="#" onclick="showView('ia-trader-view')">IA Trader</a>
                <a href="#" onclick="logout()">Sair</a>
            </div>

            <main>
                
                <div id="analysis-view" class="page-content active">
                    <h2>üìä An√°lise de Sinais ao Vivo</h2>
                    
                    <div class="card signal-card">
                        <div class="signal-value" id="signal-action">VO:</div>
                        <div class="signal-details">
                            <span class="probability" id="signal-prob">Recebendo ticks para an√°lise...</span>
                            <span class="reason muted" id="signal-reason">O sistema est√° subscrito ao Volatility 100 Index.</span>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Detalhes do Mercado</h3>
                        <div class="last-tick-info">
                            <div>
                                <p class="muted">Ativo Atual</p>
                                <p>Vol: 100 Index (R_100)</p>
                            </div>
                            <div>
                                <p class="muted">√öltimo Tick Recebido</p>
                                <p class="price-display"><span id="last-price">$0.00</span><span id="last-time" class="muted">Hora: --:--:--</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="ia-trader-view" class="page-content hidden">
                    <h2>üß† IA Trader (An√°lise T√©cnica)</h2>
                    <div class="card">
                        <h3>Pergunte √† IA</h3>
                        <div class="ia-input-group">
                            <input type="text" id="iaQuery" placeholder="Ex: O que √© RSI?">
                            <button onclick="sendIAQuery()">Perguntar</button>
                        </div>
                        <div id="iaResponse" class="ia-response-box">
                            <strong>Resposta da IA:</strong>
                            <p class="muted">Pergunte algo sobre an√°lise t√©cnica (RSI, Suporte, Resist√™ncia) para obter uma resposta simulada.</p>
                        </div>
                    </div>
                </div>

                
            </main>

            <aside>
                <h2>Logs do Sistema</h2>
                <div class="logs-container" id="system-logs">
                    </div>
            </aside>

        </div> </div> <script>
        
        // --------------------------------------
        // üö® PARTE CR√çTICA 1: URL DO SERVIDOR üö®
        // 
        // Voc√™ DEVE substituir "SEU_DOMINIO_AQUI.onrender.com" pela URL exata 
        // que o Render forneceu no seu log. Exemplo: https://mauro-paulo-starps-previus.onrender.com
        // --------------------------------------
        const SERVER = "https://SEU_DOMINIO_AQUI.onrender.com"; 

        let statusInterval; 
        let signalInterval; 
        const MAX_LOGS = 50;

        // --------------------------------------
        // FUN√á√ïES GERAIS DE UI
        // --------------------------------------

        function log(message, type = 'general') {
            const logsContainer = document.getElementById('system-logs');
            const logEl = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            logEl.className = `log-message ${type}`;
            logEl.innerHTML = `[${timestamp}] ${message}`;

            // Adiciona no topo e limita o n√∫mero de logs
            logsContainer.prepend(logEl);
            while (logsContainer.children.length > MAX_LOGS) {
                logsContainer.removeChild(logsContainer.lastChild);
            }
        }

        function showView(viewId) {
            document.querySelectorAll('.view, .page-content').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');

            // Se estiver no dashboard, garantir que a main view correta esteja ativa
            if (viewId === 'dashboard-view' || viewId.includes('-view')) {
                document.getElementById('dashboard-view').classList.add('active');
                document.getElementById(viewId).classList.add('active');
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('side-menu');
            menu.classList.toggle('open');
        }

        function logout() {
            // Limpa intervalos
            clearInterval(statusInterval);
            clearInterval(signalInterval);
            log("Sess√£o finalizada. Limpando dados.");
            // Volta para a tela de login
            showView('login-view'); 
        }

        // --------------------------------------
        // üö® PARTE CR√çTICA 2: FUN√á√ÉO DE CONEX√ÉO (CORRIGIDA) üö®
        // --------------------------------------

        async function setTokenAndConnect() {
            const token = document.getElementById('tokenInput').value;
            const statusEl = document.getElementById('auth-status');
            statusEl.textContent = "Conectando e autorizando token...";
            statusEl.style.color = 'var(--muted-color)';
            log(`Tentando conex√£o com o token...`);

            try {
                // Tenta POST para o servidor
                const r = await fetch(SERVER + "/set_token", { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });

                const j = await r.json();

                if (j.ok) {
                    // SUCESSO: Conex√£o e autoriza√ß√£o OK.
                    statusEl.textContent = j.message;
                    statusEl.style.color = 'var(--accent-green)';
                    
                    // üü¢ CORRE√á√ÉO: Acessa account_type de forma segura (resolve o erro 'toUpperCase')
                    const accountType = j.account_type || 'demo'; 
                    
                    document.getElementById('account-type').textContent = accountType.toUpperCase();
                    document.getElementById('account-type').className = `badge ${accountType.toLowerCase()}`;
                    
                    checkStatus(); // Inicia o monitoramento
                    // Inicia o loop de sinais
                    if (!signalInterval) {
                        signalInterval = setInterval(getTradingSignal, 5000); // 5 segundos
                    }

                    showView('dashboard-view');
                    showView('analysis-view');
                    log(`Conex√£o estabelecida. Conta: ${accountType.toUpperCase()}`);

                } else {
                    // FALHA DE AUTORIZA√á√ÉO (Token Inv√°lido)
                    statusEl.textContent = `Falha de Autoriza√ß√£o: ${j.message || 'Token inv√°lido.'}`;
                    statusEl.style.color = 'var(--accent-red)';
                    log(`Falha de Autoriza√ß√£o: ${j.message || 'Token inv√°lido.'}`);
                }

            } catch (e) {
                // ERRO DE REDE GERAL (Servidor n√£o encontrado ou n√£o responde)
                const errorMessage = e.message || e.toString();
                statusEl.textContent = "Erro de Rede. Verifique se o servidor est√° online.";
                statusEl.style.color = 'var(--accent-red)';
                log(`Erro de Rede ao tentar conectar: ${errorMessage}`);
            }
        }
        
        // --------------------------------------
        // FUN√á√ÉO DE STATUS E SALDO (Pode precisar de ajustes se o erro persistir)
        // --------------------------------------

        async function checkStatus() {
            try {
                const r = await fetch(SERVER + "/status");
                const j = await r.json();
                
                if (j.authorized) {
                    // Atualiza Saldo e Tipo de Conta
                    const balance = parseFloat(j.balance).toFixed(2);
                    document.getElementById('account-balance').textContent = `Saldo: $${balance}`;
                    
                    const accountType = j.account_type || 'demo';
                    document.getElementById('account-type').textContent = accountType.toUpperCase();
                    document.getElementById('account-type').className = `badge ${accountType.toLowerCase()}`;

                    // Inicia loop de verifica√ß√£o de status (a cada 15 segundos)
                    if (!statusInterval) {
                        statusInterval = setInterval(checkStatus, 15000); 
                    }

                } else if (!j.authorized && document.getElementById('dashboard-view').classList.contains('active')) {
                    // Se estiver no dashboard e perder a autoriza√ß√£o
                    logout();
                    alert("A sess√£o expirou. Por favor, fa√ßa login novamente.");
                }

            } catch (e) {
                // Erro de rede na verifica√ß√£o de status (normal se o servidor estiver reiniciando)
                log("Erro na verifica√ß√£o de status: " + e.message, 'error');
                // Mant√©m o loop de status para tentar reconectar
                if (!statusInterval) {
                    statusInterval = setInterval(checkStatus, 15000);
                }
            }
        }

        // --------------------------------------
        // FUN√á√ÉO DE SINAIS
        // --------------------------------------

        async function getTradingSignal() {
            try {
                const r = await fetch(SERVER + "/signal?symbol=R_100&tf=60"); // Assumindo R_100, 1 min
                const j = await r.json();

                const signalEl = document.getElementById('signal-action');
                const probEl = document.getElementById('signal-prob');
                const reasonEl = document.getElementById('signal-reason');
                const priceEl = document.getElementById('last-price');
                const timeEl = document.getElementById('last-time');

                // Atualiza o √∫ltimo tick
                if (j.last_tick) {
                    priceEl.textContent = `$${parseFloat(j.last_tick.price).toFixed(4)}`;
                    timeEl.textContent = `Hora: ${j.last_tick.time}`;
                }

                if (j.signal) {
                    // Sinal Recebido
                    const action = j.signal.action;
                    signalEl.textContent = action;
                    signalEl.className = `signal-value ${action.includes('CALL') ? 'signal-call' : 'signal-put'}`;
                    
                    probEl.textContent = `Probabilidade: ${j.signal.probability * 100}%`;
                    reasonEl.textContent = `Motivo: ${j.signal.reason}`;
                    log(`Sinal GERAL: ${action} - ${j.signal.probability * 100}%`, 'signal');

                } else if (j.last_tick && j.last_tick.price !== 0.0) {
                    // N√£o h√° sinal, mas h√° ticks
                    signalEl.textContent = 'Aguardando';
                    signalEl.className = 'signal-value';
                    probEl.textContent = 'N√£o h√° sinal forte o suficiente.';
                    reasonEl.textContent = 'Continue monitorando o mercado. (Necessita de mais ticks ou RSI est√° neutro.)';
                } else {
                    // Aguardando ticks (no in√≠cio)
                    signalEl.textContent = 'VO:';
                    signalEl.className = 'signal-value';
                }

            } catch (e) {
                // log("Erro na busca de sinal: " + e.message, 'error');
            }
        }
        
        // --------------------------------------
        // FUN√á√ÉO DE IA TRADER
        // --------------------------------------

        async function sendIAQuery() {
            const query = document.getElementById('iaQuery').value;
            const responseBox = document.getElementById('iaResponse');
            
            if (!query) return;

            responseBox.innerHTML = '<strong>Resposta da IA:</strong><p class=\"muted\">Analisando a sua pergunta...</p>';
            document.getElementById('iaQuery').value = '';

            try {
                const r = await fetch(SERVER + "/ia/query", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });

                const j = await r.json();
                
                if (j.response) {
                    responseBox.innerHTML = `<strong>Resposta da IA:</strong><p>${j.response}</p>`;
                } else {
                    responseBox.innerHTML = `<strong>Resposta da IA:</strong><p class=\"muted\" style=\"color:var(--accent-red)\">Erro: ${j.message || 'Resposta inv√°lida do servidor.'}</p>`;
                }

            } catch (e) {
                responseBox.innerHTML = '<strong>Resposta da IA:</strong><p class=\"muted\" style=\"color:var(--accent-red)\">Erro de rede ao consultar a IA.</p>';
                log("Erro IA: " + e.message);
            }
        }


        // --------------------------------------
        // INICIALIZA√á√ÉO
        // --------------------------------------

        window.onload = function() {
            // Verifica o status do servidor a cada 15 segundos
            checkStatus(); 
            // Inicia o loop de sinais a cada 5 segundos
            signalInterval = setInterval(getTradingSignal, 5000); 
            // Mostra a tela de login inicialmente
            showView('login-view');
        };

    </script>
</body>
</html>
