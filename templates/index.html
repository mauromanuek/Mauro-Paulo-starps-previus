<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>RobotMagic Sniper v2.5</title>
    <style>
        body { background: #0e1117; color: #fff; font-family: sans-serif; text-align: center; transition: 0.5s; margin: 0; padding: 20px; }
        .card { background: #1c1f24; padding: 20px; border-radius: 12px; margin: 10px auto; max-width: 700px; border: 1px solid #2d333b; }
        #countdown { font-size: 4em; color: #fbbf24; font-weight: bold; }
        .signal-header { font-size: 2.5em; font-weight: 800; padding: 20px; border-radius: 8px; margin: 15px 0; }
        .btn { padding: 15px 30px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; }
        #log-area { background: #000; color: #00ff41; padding: 15px; height: 150px; overflow-y: auto; text-align: left; font-family: monospace; border-radius: 5px; }
        /* Modo Sniper */
        .sniper-active { border: 12px solid #fbbf24 !important; box-shadow: 0 0 40px #fbbf24; background: #2b2100 !important; }
    </style>
</head>
<body>
    <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <div class="card">
        <h3>FECHAMENTO (5M)</h3>
        <div id="countdown">00:00</div>
    </div>

    <div class="card">
        <input type="text" id="token" placeholder="API Token Deriv" style="padding: 12px; width: 60%; border-radius: 5px; border: none;">
        <br><br>
        <button class="btn" style="background: #10b981; color: white;" onclick="start('start')">LIGAR SNIPER</button>
        <button class="btn" style="background: #ef4444; color: white;" onclick="start('stop')">PARAR</button>
    </div>

    <div id="main-card" class="card">
        <div id="signal-box" class="signal-header">AGUARDANDO...</div>
        <p id="justification" style="font-size: 1.2em;">O bot analisará Sniper e Fluxo simultaneamente.</p>
        <div style="display: flex; justify-content: space-around; font-weight: bold; color: #fbbf24;">
            <div>Confiança: <span id="conf">0</span>%</div>
            <div>Estratégia: <span id="strat">--</span></div>
        </div>
    </div>

    <div class="card">
        <h4>Logs do Sistema</h4>
        <pre id="log-area">Aguardando comando...</pre>
    </div>

    <script>
        let confidence = 0;
        const beep = document.getElementById('beep');

        // Cronómetro
        setInterval(() => {
            const now = new Date();
            const rm = 4 - (now.getUTCMinutes() % 5);
            const rs = 59 - now.getUTCSeconds();
            document.getElementById('countdown').innerText = `${rm}:${rs.toString().padStart(2, '0')}`;
            // Beep nos últimos 2 segundos se houver sinal forte
            if (rm === 0 && rs <= 2 && confidence >= 85) beep.play().catch(()=>{});
        }, 1000);

        async function start(action) {
            beep.play().catch(()=>{}); // Desbloqueia áudio no navegador
            const t = document.getElementById('token').value;
            await fetch('/control', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: action, symbol: 'R_100', api_token: t})
            });
        }

        async function update() {
            try {
                const res = await fetch('/status');
                const data = await res.json();
                const sig = data.signal_data;
                confidence = sig.confidence;

                document.getElementById('log-area').innerText = data.logs.join('\n');
                document.getElementById('log-area').scrollTop = 99999;
                
                const box = document.getElementById('signal-box');
                const card = document.getElementById('main-card');

                box.innerText = sig.direction;
                document.getElementById('justification').innerText = sig.justification;
                document.getElementById('conf').innerText = sig.confidence;
                document.getElementById('strat').innerText = sig.strategy_used;

                // Cores Vibrantes
                if(sig.direction === 'CALL') box.style.background = '#00ff41', box.style.color = '#000';
                else if(sig.direction === 'PUT') box.style.background = '#ff0000', box.style.color = '#fff';
                else box.style.background = '#374151', box.style.color = '#fff';

                // Modo Sniper (Visual Ouro)
                if(sig.confidence >= 98) card.classList.add('sniper-active'), document.body.style.background = '#1a1405';
                else card.classList.remove('sniper-active'), document.body.style.background = '#0e1117';

            } catch(e){}
        }
        setInterval(update, 2000);
    </script>
</body>
</html>
